#!/bin/bash

# Script to update Portainer and send a notification to Slack
# Usage: ./portainer-update.sh [webhook_url]

set -eo pipefail
# Slack Configuration
SLACK_PATH="/opt/slack-bash-notifications"
SLACK_WEBHOOK_URL="${1:-${SLACK_WEBHOOK_URL}}"
SLACK_PAYLOAD_FILE="${SLACK_PATH}/slack-payload.json"

# Portainer update function
update_portainer() {
  docker stop portainer
  docker rm portainer
  docker pull portainer/portainer-ce:lts
  docker run -d \
    -p 8000:8000 -p 9443:9443 \
    --name=portainer \
    --restart=always \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -v portainer_data:/data portainer/portainer-ce:lts
}

# logging function
log() {
  local message="$1"
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] $message" | tee -a "${SLACK_PATH}/portainer-update.log"
}
# Function to send a notification to Slack using the provided JSON payload
send_slack_notification() {
  local payload_file="$1"
  local webhook_url="$2"

  log "Sending Portainer update notification to Slack using payload from: $payload_file"

  if ! curl -s -X POST -H 'Content-type: application/json' --data "@$payload_file" "$webhook_url"; then
    log "ERROR: Failed to send Slack notification"
    return 1
  fi

  log "Slack notification sent successfully"
  return 0
}
# Function to validate JSON file
validate_json() {
  local file="$1"
  if ! jq empty "$file" 2>/dev/null; then
    log "ERROR: Invalid JSON in $file"
    return 1
  fi
  return 0
}
# Function to display usage information
usage() {
  echo "Usage: $0 [webhook_url]"
  echo
  echo "Arguments:"
  echo "  webhook_url    Slack webhook URL (default: value from SLACK_WEBHOOK_URL env var)"
  echo
  echo "Environment Variables:"
  echo "  SLACK_WEBHOOK_URL    Webhook URL to use if not specified as argument"
  echo
  echo "Example:"
  echo "  $0 https://hooks.slack.com/services/XXX/YYY/ZZZ"
}
# Main script logic
log "Starting Portainer update and Slack notification script"
# Check if help is requested
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
  usage
  exit 0
fi
# Check if jq is installed
if ! command -v jq &>/dev/null; then
  log "ERROR: jq is not installed. Please install jq to use this script."
  exit 1
fi
# Check if curl is installed
if ! command -v curl &>/dev/null; then
  log "ERROR: curl is not installed. Please install curl to use this script."
  exit 1
fi
# Check if Docker is installed
if ! command -v docker &>/dev/null; then
  log "ERROR: Docker is not installed. Please install Docker to use this script."
  exit 1
fi
# Check if Docker is running
if ! systemctl is-active --quiet docker; then
  log "ERROR: Docker is not running. Please start Docker to use this script."
  exit 1
fi
# Validate inputs
if [[ -z "$SLACK_WEBHOOK_URL" ]]; then
  log "ERROR: No webhook URL specified. Set SLACK_WEBHOOK_URL env var or provide as argument."
  usage
  exit 1
fi
# Validate JSON payload file
if [[ ! -f "$SLACK_PAYLOAD_FILE" ]]; then
  log "ERROR: Payload file not found: $SLACK_PAYLOAD_FILE"
  exit 1
fi
if ! validate_json "$SLACK_PAYLOAD_FILE"; then
  log "ERROR: Invalid JSON in payload file: $SLACK_PAYLOAD_FILE"
  exit 1
fi
# Update Portainer
log "Updating Portainer..."
if update_portainer; then
  log "Portainer updated successfully"
else
  log "ERROR: Portainer update failed"
  exit 1
fi
# Send Slack notification
log "Sending Slack notification..."
if send_slack_notification "$SLACK_PAYLOAD_FILE" "$SLACK_WEBHOOK_URL"; then
  log "Slack notification sent successfully"
else
  log "ERROR: Failed to send Slack notification"
  exit 1
fi
# End of script
log "Portainer update and Slack notification script completed successfully"
